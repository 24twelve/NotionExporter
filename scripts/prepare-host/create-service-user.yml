---
- name: Create service user with sudo rights  
  hosts: production
  vars:
    ansible_user: root
    ansible_ssh_password: "{{ root_user_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
  tasks:
  - name: Make sure we have a 'wheel' group
    group:
      name: wheel
      state: present
    become: true
  - name: Allow 'wheel' group to have passwordless sudo
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^%wheel'
      line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'
    become: true
  - name: Create service user
    ansible.builtin.user:
      name: "{{ service_user_name }}"
      password: "{{ service_user_password | password_hash('sha512') }}"
      groups: wheel
      comment: "generated by ansible script"
      shell: "/bin/bash"
    become: true
  - name: Set authorized SSH key
    authorized_key:
      user: "{{ service_user_name }}"
      state: present
      key: "{{ lookup('file',  ansible_ssh_public_key_file) }}"
    become: true
